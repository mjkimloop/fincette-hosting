<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>핀셋리포트 - 실시간 분석 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif !important;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-extrabold text-gray-800">실시간 전환 분석 대시보드</h1>
            <p class="text-md text-gray-500 mt-2">핀셋리포트의 핵심 퍼널 데이터를 실시간으로 추적합니다.</p>
        </header>

        <!-- 데이터 요약 카드 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-gray-500 text-sm font-medium">리마인드 노출</h2>
                <p id="reminders-exposed" class="text-3xl font-bold text-gray-800 mt-1">0</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-gray-500 text-sm font-medium">리마인드 클릭</h2>
                <p id="reminders-clicked" class="text-3xl font-bold text-blue-600 mt-1">0</p>
                <p id="click-rate" class="text-sm text-gray-500 mt-1">(0.0%)</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-gray-500 text-sm font-medium">리포트 저장</h2>
                <p id="reports-saved" class="text-3xl font-bold text-green-600 mt-1">0</p>
                <p id="save-rate" class="text-sm text-gray-500 mt-1">(0.0%)</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-gray-500 text-sm font-medium">전문가 요청</h2>
                <p id="expert-requested" class="text-3xl font-bold text-purple-600 mt-1">0</p>
                <p id="request-rate" class="text-sm text-gray-500 mt-1">(0.0%)</p>
            </div>
        </div>

        <!-- 시각화 차트 -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-lg font-bold text-gray-800 mb-4">전환 퍼널 시각화</h2>
            <canvas id="conversionChart"></canvas>
        </div>
        
        <div class="text-center mt-4">
             <p id="last-updated" class="text-xs text-gray-400">데이터를 불러오는 중...</p>
        </div>

    </div>

    <!-- Firebase 및 차트 로직 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // [중요] 아래 firebaseConfig 객체를 선생님의 Firebase 프로젝트 설정값으로 교체해주세요.
        const firebaseConfig = {
            apiKey: "AIzaSyBNjNWAImm2FPHlJFM4Nej4asrdEw-fOEQ",
            authDomain: "fincette-report-mvp.firebaseapp.com",
            projectId: "fincette-report-mvp",
            storageBucket: "fincette-report-mvp.firebasestorage.app",
            messagingSenderId: "410308058859",
            appId: "1:410308058859:web:eeba8d588186441a71e8ae"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Chart.js 인스턴스 생성
        const ctx = document.getElementById('conversionChart').getContext('2d');
        const conversionChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['리마인드 노출', '리마인드 클릭', '리포트 저장', '전문가 요청'],
                datasets: [{
                    label: '전환 수',
                    data: [0, 0, 0, 0],
                    backgroundColor: [
                        'rgba(201, 203, 207, 0.4)',
                        'rgba(59, 130, 246, 0.4)',
                        'rgba(16, 185, 129, 0.4)',
                        'rgba(147, 51, 234, 0.4)'
                    ],
                    borderColor: [
                        'rgb(201, 203, 207)',
                        'rgb(59, 130, 246)',
                        'rgb(16, 185, 129)',
                        'rgb(147, 51, 234)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // 실시간 데이터 분석 및 대시보드 업데이트 함수
        function analyzeData(reminders, executions) {
            let exposedCount = reminders.length;
            let clickedCount = reminders.filter(doc => doc.data().clicked === true).length;
            
            let savedCount = executions.filter(doc => doc.data().executionSource === "download").length;
            let requestedCount = executions.filter(doc => doc.data().executionSource === "expert_request_consult").length;

            // 수치 업데이트
            document.getElementById('reminders-exposed').textContent = exposedCount;
            document.getElementById('reminders-clicked').textContent = clickedCount;
            document.getElementById('reports-saved').textContent = savedCount;
            document.getElementById('expert-requested').textContent = requestedCount;

            // 비율 업데이트
            document.getElementById('click-rate').textContent = `(${(exposedCount > 0 ? (clickedCount / exposedCount) * 100 : 0).toFixed(1)}%)`;
            document.getElementById('save-rate').textContent = `(${(exposedCount > 0 ? (savedCount / exposedCount) * 100 : 0).toFixed(1)}%)`;
            document.getElementById('request-rate').textContent = `(${(exposedCount > 0 ? (requestedCount / exposedCount) * 100 : 0).toFixed(1)}%)`;
            
            // 차트 데이터 업데이트
            conversionChart.data.datasets[0].data = [exposedCount, clickedCount, savedCount, requestedCount];
            conversionChart.update();
            
            // 마지막 업데이트 시간 표시
            document.getElementById('last-updated').textContent = `마지막 업데이트: ${new Date().toLocaleTimeString()}`;
        }

        // Firestore 실시간 리스너 설정
        const remindersRef = collection(db, "reminders");
        const executionsRef = collection(db, "executions");

        let remindersCache = [];
        let executionsCache = [];

        onSnapshot(remindersRef, (snapshot) => {
            remindersCache = snapshot.docs;
            analyzeData(remindersCache, executionsCache);
        });

        onSnapshot(executionsRef, (snapshot) => {
            executionsCache = snapshot.docs;
            analyzeData(remindersCache, executionsCache);
        });

    </script>

</body>
</html>
