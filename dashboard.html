<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•€ì…‹ë¦¬í¬íŠ¸ - ì‹¤ì‹œê°„ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif !important;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-extrabold text-gray-800">ğŸ“Š ì‹¤ì‹œê°„ ì „í™˜ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
            <p class="text-md text-gray-500 mt-2">í•€ì…‹ë¦¬í¬íŠ¸ì˜ í•µì‹¬ í¼ë„ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¶”ì í•©ë‹ˆë‹¤.</p>
        </header>

        <!-- ë°ì´í„° ìš”ì•½ ì¹´ë“œ -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            <div class="bg-white p-4 rounded-xl shadow-md text-center">
                <h2 class="text-gray-500 text-sm font-medium">ì´ ìœ ì…</h2>
                <p id="total-traffic" class="text-3xl font-bold text-gray-800 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md text-center">
                <h2 class="text-gray-500 text-sm font-medium">ë¦¬í¬íŠ¸ ì¡°íšŒ</h2>
                <p id="reports-viewed" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                <p id="view-rate" class="text-sm text-gray-500 mt-1">(-)</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md text-center">
                <h2 class="text-gray-500 text-sm font-medium">ë¦¬í¬íŠ¸ ì‹¤í–‰</h2>
                <p id="reports-executed" class="text-3xl font-bold text-indigo-600 mt-1">0</p>
                <p id="execution-rate" class="text-sm text-gray-500 mt-1">(-)</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md text-center">
                <h2 class="text-gray-500 text-sm font-medium">ì „ë¬¸ê°€ ìš”ì²­</h2>
                <p id="expert-requested" class="text-3xl font-bold text-purple-600 mt-1">0</p>
                <p id="request-rate" class="text-sm text-gray-500 mt-1">(-)</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md text-center">
                <h2 class="text-gray-500 text-sm font-medium">ë¦¬ë§ˆì¸ë“œ ë°œì†¡</h2>
                <p id="reminders-sent" class="text-3xl font-bold text-gray-800 mt-1">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md text-center">
                <h2 class="text-gray-500 text-sm font-medium">ë¦¬ë§ˆì¸ë“œ í´ë¦­</h2>
                <p id="reminders-clicked" class="text-3xl font-bold text-blue-600 mt-1">0</p>
                <p id="reminder-click-rate" class="text-sm text-gray-500 mt-1">(-)</p>
            </div>
        </div>

        <!-- ì‹œê°í™” ì°¨íŠ¸ -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-lg font-bold text-gray-800 mb-4">ì „í™˜ í¼ë„ ì‹œê°í™”</h2>
            <canvas id="conversionChart"></canvas>
        </div>
        
        <div class="text-center mt-4">
             <p id="last-updated" class="text-xs text-gray-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

    </div>

    <!-- Firebase ë° ì°¨íŠ¸ ë¡œì§ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // [ì¤‘ìš”] ì•„ë˜ firebaseConfig ê°ì²´ë¥¼ ì„ ìƒë‹˜ì˜ Firebase í”„ë¡œì íŠ¸ ì„¤ì •ê°’ìœ¼ë¡œ êµì²´í•´ì£¼ì„¸ìš”.
        const firebaseConfig = {
            apiKey: "AIzaSyBNjNWAImm2FPHlJFM4Nej4asrdEw-fOEQ",
            authDomain: "fincette-report-mvp.firebaseapp.com",
            projectId: "fincette-report-mvp",
            storageBucket: "fincette-report-mvp.firebasestorage.app",
            messagingSenderId: "410308058859",
            appId: "1:410308058859:web:eeba8d588186441a71e8ae"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Chart.js ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        const ctx = document.getElementById('conversionChart').getContext('2d');
        const conversionChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['ì´ ìœ ì…', 'ë¦¬í¬íŠ¸ ì¡°íšŒ', 'ë¦¬í¬íŠ¸ ì‹¤í–‰', 'ì „ë¬¸ê°€ ìš”ì²­', 'ë¦¬ë§ˆì¸ë“œ ë°œì†¡', 'ë¦¬ë§ˆì¸ë“œ í´ë¦­'],
                datasets: [{
                    label: 'ì „í™˜ ìˆ˜',
                    data: [0, 0, 0, 0, 0, 0],
                    backgroundColor: [
                        'rgba(107, 114, 128, 0.4)',
                        'rgba(75, 85, 99, 0.4)',
                        'rgba(79, 70, 229, 0.4)',
                        'rgba(147, 51, 234, 0.4)',
                        'rgba(201, 203, 207, 0.4)',
                        'rgba(59, 130, 246, 0.4)'
                    ],
                    borderColor: [
                        'rgb(107, 114, 128)',
                        'rgb(75, 85, 99)',
                        'rgb(79, 70, 229)',
                        'rgb(147, 51, 234)',
                        'rgb(201, 203, 207)',
                        'rgb(59, 130, 246)'
                    ],
                    borderWidth: 1
                }]
            },
            options: { scales: { y: { beginAtZero: true } }, responsive: true, plugins: { legend: { display: false } } }
        });

        // ì‹¤ì‹œê°„ ë°ì´í„° ë¶„ì„ ë° ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function analyzeData(trafficLogs, reports, executions, reminders) {
            const trafficCount = trafficLogs.length;
            const viewedCount = reports.filter(doc => doc.data().viewedAt).length;
            const executedCount = executions.filter(doc => doc.data().isRealExecution === true).length;
            const requestedCount = executions.filter(doc => doc.data().executionSource === "expert_request_consult").length;
            const remindersSentCount = reminders.length;
            const remindersClickedCount = reminders.filter(doc => doc.data().clicked === true).length;

            // ìˆ˜ì¹˜ ì—…ë°ì´íŠ¸
            document.getElementById('total-traffic').textContent = trafficCount;
            document.getElementById('reports-viewed').textContent = viewedCount;
            document.getElementById('reports-executed').textContent = executedCount;
            document.getElementById('expert-requested').textContent = requestedCount;
            document.getElementById('reminders-sent').textContent = remindersSentCount;
            document.getElementById('reminders-clicked').textContent = remindersClickedCount;

            // ì „í™˜ìœ¨ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
            document.getElementById('view-rate').textContent = `(${(trafficCount > 0 ? (viewedCount / trafficCount) * 100 : 0).toFixed(1)}%)`;
            document.getElementById('execution-rate').textContent = `(${(viewedCount > 0 ? (executedCount / viewedCount) * 100 : 0).toFixed(1)}%)`;
            document.getElementById('request-rate').textContent = `(${(executedCount > 0 ? (requestedCount / executedCount) * 100 : 0).toFixed(1)}%)`;
            document.getElementById('reminder-click-rate').textContent = `(${(remindersSentCount > 0 ? (remindersClickedCount / remindersSentCount) * 100 : 0).toFixed(1)}%)`;
            
            // ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
            conversionChart.data.datasets[0].data = [trafficCount, viewedCount, executedCount, requestedCount, remindersSentCount, remindersClickedCount];
            conversionChart.update();
            
            document.getElementById('last-updated').textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString()}`;
        }

        // Firestore ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        const collections = {
            trafficLogs: [],
            reports: [],
            executions: [],
            reminders: []
        };

        function updateDashboard() {
            analyzeData(collections.trafficLogs, collections.reports, collections.executions, collections.reminders);
        }

        onSnapshot(collection(db, "trafficLogs"), (snapshot) => { collections.trafficLogs = snapshot.docs; updateDashboard(); });
        onSnapshot(collection(db, "reports"), (snapshot) => { collections.reports = snapshot.docs; updateDashboard(); });
        onSnapshot(collection(db, "executions"), (snapshot) => { collections.executions = snapshot.docs; updateDashboard(); });
        onSnapshot(collection(db, "reminders"), (snapshot) => { collections.reminders = snapshot.docs; updateDashboard(); });

    </script>

</body>
</html>
